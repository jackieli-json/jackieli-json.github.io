<!DOCTYPE html><html class="theme-lattice"><head><meta charset="utf-8"><title>H5直播起航 | Aotu.io「凹凸实验室」</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="凹凸实验室"><meta name="designer" content="凹凸实验室"><meta name="rating" content="general"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="index, follow"><meta name="keywords" content="HLS、RTMP协议,H5 视频直播 video,H5,凹凸实验室,Aotu,前端开发,全栈开发,IOS开发,Android开发"><link rel="canonical" href="https://aotu.io/notes/2016/10/09/HTML5-SopCast/index.html"><link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="60x60" href="/img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png"><link rel="icon" type="image/png" href="/img/favicon-230x230.png" sizes="230x230"><link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16"><link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32"><meta name="msapplication-TileColor" content="#2f83cd"><meta name="msapplication-TileImage" content="/img/mstile-144x144.png"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="Aotu.io"><meta name="description" content="前言前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。
发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目前以 HLS 为主（HLS存在延迟性问题，也可以借助 video.js  采用RTMP），PC端则以 RTMP 为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。
一、视频流协议H"><meta property="og:type" content="article"><meta property="og:title" content="H5直播起航"><meta property="og:url" content="https://aotu.io/notes/2016/10/09/HTML5-SopCast/index.html"><meta property="og:site_name" content="Aotu.io"><meta property="og:description" content="前言前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。
发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目前以 HLS 为主（HLS存在延迟性问题，也可以借助 video.js  采用RTMP），PC端则以 RTMP 为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。
一、视频流协议H"><meta property="og:image" content="https://aotu.io//misc.aotu.io/pfan123/sopcast/1.png"><meta property="og:image" content="https://aotu.io//misc.aotu.io/pfan123/sopcast/2.png"><meta property="og:image" content="https://aotu.io//misc.aotu.io/pfan123/sopcast/3.png"><meta property="og:image" content="https://aotu.io//misc.aotu.io/pfan123/sopcast/4.png"><meta property="og:updated_time" content="2016-10-20T07:06:32.451Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="H5直播起航"><meta name="twitter:description" content="前言前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。
发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目前以 HLS 为主（HLS存在延迟性问题，也可以借助 video.js  采用RTMP），PC端则以 RTMP 为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。
一、视频流协议H"><meta name="twitter:image" content="https://aotu.io//misc.aotu.io/pfan123/sopcast/1.png"><meta name="twitter:site" content="o2circle"><script>var App={root:"/",isHome:!1,isCate:!1,isTag:!1}</script></head><body class="page-post-detail"><div class="mod-hd"><div class="grid"><div class="mod-logo"><a href="/index.html" title="Aotu.io">Aotu.io</a></div><span class="mod-hd-toggle" id="J_hdToggle"><i class="fa fa-bars"></i></span><div class="mod-hd-main"><div class="mod-hd-inner"><nav class="mod-nav"><ul class="mod-nav-list"><li class="main-nav-item"><a href="/index.html" class="main-nav-link">首页</a></li><li class="main-nav-item"><a href="/about/" class="main-nav-link">关于</a></li><li class="main-nav-item"><a href="/join/" class="main-nav-link">加入我们</a></li></ul></nav><div class="mod-search"><a class="fa fa-search mod-search-ico" id="J_searchTrigger" title="搜索"></a><form id="J_searchForm" method="get" class="mod-search-form" action="/search/"><input type="text" name="query" class="mod-search-ipt" id="J_searchInput" placeholder="搜索"></form></div></div></div></div></div><div class="mod-container"><div class="grid"><div class="mod-main"><article class="post"><header class="post-hd"><h2 class="post-tit">H5直播起航</h2><div class="post-meta">by <a target="_blank" href="https://github.com/pfan123" class="post-author">高大师</a> on <span>2016-10-09</span></div><p class="post-subtit" style="display:none"><i class="fa fa-quote-left"></i>直播这么火，想直播写代码的冲动吗，那还等什么，一起开始做H5直播吧～～</p><span style="display:none" id="busuanzi_value_page_pv"></span></header><div class="post-cover"><img src="//misc.aotu.io/pfan123/sopcast/banner.png" alt="H5直播起航"></div><div class="post-content"><a id="more"></a><h2 id="前言" class="post-heading"><a href="#前言" class="headerlink" title="前言"></a>前言<a class="post-anchor" href="#前言" aria-hidden="true"></a></h2><p>前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。</p><p>发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目前以 HLS 为主（HLS存在延迟性问题，也可以借助 <a href="https://github.com/videojs/video.js" target="_blank" rel="external">video.js</a> 采用RTMP），PC端则以 RTMP 为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。</p><h2 id="一、视频流协议HLS与RTMP" class="post-heading"><a href="#一、视频流协议HLS与RTMP" class="headerlink" title="一、视频流协议HLS与RTMP"></a>一、视频流协议HLS与RTMP<a class="post-anchor" href="#一、视频流协议HLS与RTMP" aria-hidden="true"></a></h2><h3 id="1-HTTP-Live-Streaming" class="post-heading"><a href="#1-HTTP-Live-Streaming" class="headerlink" title="1. HTTP Live Streaming"></a>1. HTTP Live Streaming<a class="post-anchor" href="#1-HTTP-Live-Streaming" aria-hidden="true"></a></h3><p>HTTP Live Streaming（简称 HLS）是一个基于 HTTP 的视频流协议，由 Apple 公司实现，Mac OS 上的 QuickTime、Safari 以及 iOS 上的 Safari 都能很好的支持 HLS，高版本 Android 也增加了对 HLS 的支持。一些常见的客户端如：MPlayerX、VLC 也都支持 HLS 协议。</p><p>HLS 协议基于 HTTP，而一个提供 HLS 的服务器需要做两件事：</p><ul><li>编码：以 H.263 格式对图像进行编码，以 MP3 或者 HE-AAC 对声音进行编码，最终打包到 MPEG-2 TS（Transport Stream）容器之中；</li><li>分割：把编码好的 TS 文件等长切分成后缀为 ts 的小文件，并生成一个 .m3u8 的纯文本索引文件；</li></ul><p>浏览器使用的是 m3u8 文件。m3u8 跟音频列表格式 m3u 很像，可以简单的认为 m3u8 就是包含多个 ts 文件的播放列表。播放器按顺序逐个播放，全部放完再请求一下 m3u8 文件，获得包含最新 ts 文件的播放列表继续播，周而复始。整个直播过程就是依靠一个不断更新的 m3u8 和一堆小的 ts 文件组成，m3u8 必须动态更新，ts 可以走 CDN。一个典型的 m3u8 文件格式如下：</p><blockquote><p>#EXTM3U</p><p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=200000<br>gear1/prog_index.m3u8</p><p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=311111<br>gear2/prog_index.m3u8</p><p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=484444<br>gear3/prog_index.m3u8</p><p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=737777<br>gear4/prog_index.m3u8</p></blockquote><p>可以看到 HLS 协议本质还是一个个的 HTTP 请求 / 响应，所以适应性很好，不会受到防火墙影响。但它也有一个致命的弱点：延迟现象非常明显。如果每个 ts 按照 5 秒来切分，一个 m3u8 放 6 个 ts 索引，那么至少就会带来 30 秒的延迟。如果减少每个 ts 的长度，减少 m3u8 中的索引数，延时确实会减少，但会带来更频繁的缓冲，对服务端的请求压力也会成倍增加。所以只能根据实际情况找到一个折中的点。</p><p>对于支持 HLS 的浏览器来说，直接这样写就能播放了：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;video src=<span class="string">"http://devimages.apple.com/iphone/samples/bipbop/bipbopall.m3u8"</span></div><div class="line"><span class="built_in">height</span>=<span class="string">"300"</span> <span class="built_in">width</span>=<span class="string">"400"</span>  preload=<span class="string">"auto"</span> autoplay=<span class="string">"autoplay"</span> <span class="built_in">loop</span>=<span class="string">"loop"</span> webkit-playsinline=<span class="string">"true"</span>&gt;&lt;/video&gt;</div></pre></td></tr></table></figure><p><code>注意</code>：HLS 在 PC 端仅支持safari浏览器，类似chrome浏览器使用<code>HTML5 video</code>标签无法播放 m3u8 格式，可直接采用网上一些比较成熟的方案，如：<a href="https://github.com/jackzhang1204/sewise-player" target="_blank" rel="external">sewise-player</a>、<a href="https://github.com/johndyer/mediaelement" target="_blank" rel="external">MediaElement</a>、<a href="https://github.com/videojs/videojs-contrib-hls" target="_blank" rel="external">videojs-contrib-hls</a>、<a href="https://github.com/jwplayer/jwplayer" target="_blank" rel="external">jwplayer</a>。</p><h3 id="2-Real-Time-Messaging-Protocol" class="post-heading"><a href="#2-Real-Time-Messaging-Protocol" class="headerlink" title="2. Real Time Messaging Protocol"></a>2. Real Time Messaging Protocol<a class="post-anchor" href="#2-Real-Time-Messaging-Protocol" aria-hidden="true"></a></h3><p>Real Time Messaging Protocol（简称 RTMP）是 Macromedia 开发的一套视频直播协议，现在属于 Adobe。这套方案需要搭建专门的 RTMP 流媒体服务如 Adobe Media Server，并且在浏览器中只能使用 Flash 实现播放器。它的实时性非常好，延迟很小，但无法支持移动端 WEB 播放是它的硬伤。</p><p>虽然无法在iOS的H5页面播放，但是对于iOS原生应用是可以自己写解码去解析的, RTMP 延迟低、实时性较好。</p><p>浏览器端，<code>HTML5 video</code>标签无法播放 RTMP 协议的视频，可以通过 <a href="https://github.com/videojs/video.js" target="_blank" rel="external">video.js</a> 来实现。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"http://vjs.zencdn.net/5.8.8/video-js.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">"example_video_1"</span> <span class="attr">class</span>=<span class="string">"video-js vjs-default-skin"</span> <span class="attr">controls</span> <span class="attr">preload</span>=<span class="string">"auto"</span> <span class="attr">width</span>=<span class="string">"640"</span> <span class="attr">height</span>=<span class="string">"264"</span> <span class="attr">loop</span>=<span class="string">"loop"</span> <span class="attr">webkit-playsinline</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">"rtmp://10.14.221.17:1935/rtmplive/home"</span> <span class="attr">type</span>=<span class="string">'rtmp/flv'</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://vjs.zencdn.net/5.8.8/video.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript"></span></div><div class="line">videojs.options.flash.swf = <span class="string">'video.swf'</span>;</div><div class="line">videojs(<span class="string">'example_video_1'</span>).ready(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.play();</div><div class="line">&#125;);</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="3-视频流协议HLS与RTMP对比" class="post-heading"><a href="#3-视频流协议HLS与RTMP对比" class="headerlink" title="3. 视频流协议HLS与RTMP对比"></a>3. 视频流协议HLS与RTMP对比<a class="post-anchor" href="#3-视频流协议HLS与RTMP对比" aria-hidden="true"></a></h3><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">协议</th><th style="text-align:center">原理</th><th style="text-align:center">延时</th><th style="text-align:center">优点</th><th style="text-align:center">使用场景</th></tr></thead><tbody><tr><td style="text-align:center">HLS</td><td style="text-align:center">短链接Http</td><td style="text-align:center">集合一段时间数据生成ts切片文件更新m3u8文件</td><td style="text-align:center">10s - 30s</td><td style="text-align:center">跨平台</td><td style="text-align:center">移动端为主</td></tr><tr><td style="text-align:center">RTMP</td><td style="text-align:center">长链接Tcp</td><td style="text-align:center">每个时刻的数据收到后立即发送</td><td style="text-align:center">2s</td><td style="text-align:center">延时低、实时性好</td><td style="text-align:center">PC+直播+实时性要求高＋互动性强</td></tr></tbody></table><h2 id="二、直播形式" class="post-heading"><a href="#二、直播形式" class="headerlink" title="二、直播形式"></a>二、直播形式<a class="post-anchor" href="#二、直播形式" aria-hidden="true"></a></h2><p><img src="//misc.aotu.io/pfan123/sopcast/1.png" alt="直播形式"></p><p>目前直播展示形式，通常以YY直播、映客直播这种页面居多，可以看到其结构可以分成三层：① 背景视频层 ② 关注、评论模块 ③ 点赞动画</p><p>而现行H5类似直播页面，实现技术难点不大，其可以通过实现方式分为：① 底部视频背景使用video视频标签实现播放 ② 关注、评论模块利用 WebScoket 来实时发送和接收新的消息通过DOM 和 CSS3 实现 ③ 点赞利用 CSS3 动画</p><p>了解完直播形式之后，接下来整体了解直播流程。</p><h2 id="三、直播整体流程" class="post-heading"><a href="#三、直播整体流程" class="headerlink" title="三、直播整体流程"></a>三、直播整体流程<a class="post-anchor" href="#三、直播整体流程" aria-hidden="true"></a></h2><p>直播整体流程大致可分为：</p><ul><li><p>视频采集端：可以是电脑上的音视频输入设备、或手机端的摄像头、或麦克风，目前以移动端手机视频为主。</p></li><li><p>直播流视频服务端：一台Nginx服务器，采集视频录制端传输的视频流(H264/ACC编码)，由服务器端进行解析编码，推送RTMP/HLS格式视频流至视频播放端。</p></li><li><p>视频播放端：可以是电脑上的播放器（QuickTime Player、VLC），手机端的native播放器，还有就是 H5 的video标签等，目前还是以手机端的native播放器为主。</p></li></ul><p><img src="//misc.aotu.io/pfan123/sopcast/2.png" alt="直播整体流程"></p><h2 id="四、H5-录制视频" class="post-heading"><a href="#四、H5-录制视频" class="headerlink" title="四、H5 录制视频"></a>四、H5 录制视频<a class="post-anchor" href="#四、H5-录制视频" aria-hidden="true"></a></h2><p>对于H5视频录制，可以使用强大的 webRTC （Web Real-Time Communication）是一个支持网页浏览器进行实时语音对话或视频对话的技术，缺点是只在 PC 的 Chrome 上支持较好，移动端支持不太理想。</p><h3 id="1-使用-webRTC-录制视频基本流程" class="post-heading"><a href="#1-使用-webRTC-录制视频基本流程" class="headerlink" title="1. 使用 webRTC 录制视频基本流程"></a>1. 使用 webRTC 录制视频基本流程<a class="post-anchor" href="#1-使用-webRTC-录制视频基本流程" aria-hidden="true"></a></h3><p>① 调用 <code>window.navigator.webkitGetUserMedia()</code> 获取用户的PC摄像头视频数据。<br>② 将获取到视频流数据转换成 <code>window.webkitRTCPeerConnection</code> (一种视频流数据格式)。<br>③ 利用 <code>WebScoket</code> 将视频流数据传输到服务端。</p><p><code>注意</code>：虽然Google一直在推WebRTC，目前已有不少成型的产品出现，但是大部分移动端的浏览器还不支持 webRTC（最新iOS 10.0也不支持），所以真正的视频录制还是要靠客户端（iOS,Android）来实现,效果会好一些。<br><img src="//misc.aotu.io/pfan123/sopcast/3.png" alt="WebRTC支持度"></p><h3 id="2-iOS原生应用调用摄像头录制视频流程" class="post-heading"><a href="#2-iOS原生应用调用摄像头录制视频流程" class="headerlink" title="2. iOS原生应用调用摄像头录制视频流程"></a>2. iOS原生应用调用摄像头录制视频流程<a class="post-anchor" href="#2-iOS原生应用调用摄像头录制视频流程" aria-hidden="true"></a></h3><p>① 音视频的采集，利用AVCaptureSession和AVCaptureDevice可以采集到原始的音视频数据流。<br>② 对视频进行H264编码，对音频进行AAC编码，在iOS中分别有已经封装好的编码库（<a href="https://github.com/kewlbear/x264-ios" target="_blank" rel="external">x264编码</a>、<a href="https://github.com/fflydev/faac-ios-build" target="_blank" rel="external">faac编码</a>、<a href="https://github.com/kewlbear/FFmpeg-iOS-build-script" target="_blank" rel="external">ffmpeg编码</a>）来实现对音视频的编码。<br>③ 对编码后的音、视频数据进行组装封包。<br>④ 建立RTMP连接并上推到服务端。</p><p><img src="//misc.aotu.io/pfan123/sopcast/4.png" alt="视频流程"></p><h2 id="五、搭建Nginx-Rtmp直播流服务" class="post-heading"><a href="#五、搭建Nginx-Rtmp直播流服务" class="headerlink" title="五、搭建Nginx+Rtmp直播流服务"></a>五、搭建Nginx+Rtmp直播流服务<a class="post-anchor" href="#五、搭建Nginx-Rtmp直播流服务" aria-hidden="true"></a></h2><h3 id="1-安装nginx、nginx-rtmp-module" class="post-heading"><a href="#1-安装nginx、nginx-rtmp-module" class="headerlink" title="1. 安装nginx、nginx-rtmp-module"></a>1. 安装nginx、nginx-rtmp-module<a class="post-anchor" href="#1-安装nginx、nginx-rtmp-module" aria-hidden="true"></a></h3><p>① 先clone nginx项目到本地：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span>tap homebrew/nginx</div></pre></td></tr></table></figure><p>② 执行安装<code>nginx-rtmp-module</code></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install nginx-full --<span class="keyword">with</span>-rtmp-<span class="class"><span class="keyword">module</span></span></div></pre></td></tr></table></figure><h3 id="2-nginx-conf配置文件，配置RTMP、HLS" class="post-heading"><a href="#2-nginx-conf配置文件，配置RTMP、HLS" class="headerlink" title="2. nginx.conf配置文件，配置RTMP、HLS"></a>2. nginx.conf配置文件，配置RTMP、HLS<a class="post-anchor" href="#2-nginx-conf配置文件，配置RTMP、HLS" aria-hidden="true"></a></h3><p>查找到nginx.conf配置文件（路径/usr/local/etc/nginx/nginx.conf），配置RTMP、HLS。</p><p>① 在http节点之前添加 rtmp 的配置内容：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="section">rtmp</span> &#123;</div><div class="line">  <span class="section">server</span> &#123;</div><div class="line">     <span class="comment">#监听的端口</span></div><div class="line">      <span class="attribute">listen</span> <span class="number">1935</span>;</div><div class="line">      <span class="comment"># RTMP 直播流配置</span></div><div class="line">      <span class="attribute">application</span> rtmplive &#123;</div><div class="line">          <span class="attribute">live</span> <span class="literal">on</span>;</div><div class="line">	      <span class="comment">#为 rtmp 引擎设置最大连接数。默认为 off</span></div><div class="line">	      <span class="attribute">max_connections</span> <span class="number">1024</span>;</div><div class="line">       &#125;</div><div class="line">	  <span class="comment"># HLS 直播流配置</span></div><div class="line">      <span class="attribute">application</span> hls&#123;</div><div class="line">          <span class="attribute">live</span> <span class="literal">on</span>;</div><div class="line">          <span class="attribute">hls</span> <span class="literal">on</span>;</div><div class="line">          <span class="attribute">hls_path</span> /usr/local/var/www/hls;</div><div class="line">          <span class="attribute">hls_fragment</span> <span class="number">1s</span>;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>② 在http中添加 hls 的配置</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">location /<span class="class">hls </span>&#123;  </div><div class="line">       <span class="meta"># Serve HLS fragments  </span></div><div class="line">       <span class="class">types </span>&#123;  </div><div class="line">           application/vnd.apple.mpegurl m3u8;  </div><div class="line">           video/mp2t ts;  </div><div class="line">       &#125;  </div><div class="line">       root <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/var/</span>www;  </div><div class="line">       <span class="meta">#add_header Cache-Controll no-cache;</span></div><div class="line">       expires <span class="number">-1</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><h3 id="3-重启nginx服务" class="post-heading"><a href="#3-重启nginx服务" class="headerlink" title="3. 重启nginx服务"></a>3. 重启nginx服务<a class="post-anchor" href="#3-重启nginx服务" aria-hidden="true"></a></h3><p>重启nginx服务，浏览器中输入 <a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a>，是否出现欢迎界面确定nginx重启成功。<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx <span class="_">-s</span> reload</div></pre></td></tr></table></figure><p></p><h2 id="六、直播流转换格式、编码推流" class="post-heading"><a href="#六、直播流转换格式、编码推流" class="headerlink" title="六、直播流转换格式、编码推流"></a>六、直播流转换格式、编码推流<a class="post-anchor" href="#六、直播流转换格式、编码推流" aria-hidden="true"></a></h2><p>当服务器端接收到采集视频录制端传输过来的视频流时，需要对其进行解析编码，推送RTMP/HLS格式视频流至视频播放端。通常使用的常见编码库方案，如<a href="https://github.com/kewlbear/x264-ios" target="_blank" rel="external">x264编码</a>、<a href="https://github.com/fflydev/faac-ios-build" target="_blank" rel="external">faac编码</a>、<a href="https://github.com/kewlbear/FFmpeg-iOS-build-script" target="_blank" rel="external">ffmpeg编码</a>等。</p><p>鉴于 FFmpeg 工具集合了多种音频、视频格式编码，我们可以优先选用FFmpeg进行转换格式、编码推流。</p><p>1.安装 FFmpeg 工具<br></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span><span class="keyword">install </span>ffmpeg</div></pre></td></tr></table></figure><p></p><p>2.推流MP4文件</p><p>视频文件地址：/Users/gao/Desktop/video/test.mp4<br>推流拉流地址：rtmp://localhost:1935/rtmplive/home，rtmp://localhost:1935/rtmplive/home</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//RTMP 协议流</span></div><div class="line">ffmpeg -re -<span class="selector-tag">i</span> /Users/gao/Desktop/video/test<span class="selector-class">.mp4</span> -vcodec libx264 -acodec aac -f flv rtmp:<span class="comment">//10.14.221.17:1935/rtmplive/home</span></div><div class="line"></div><div class="line"><span class="comment">//HLS 协议流</span></div><div class="line">ffmpeg -re -<span class="selector-tag">i</span> /Users/gao/Desktop/video/test<span class="selector-class">.mp4</span> -vcodec libx264 -vprofile baseline -acodec aac -ar <span class="number">44100</span> -strict -<span class="number">2</span> -ac <span class="number">1</span> -f flv  -<span class="selector-tag">q</span> <span class="number">10</span> rtmp:<span class="comment">//10.14.221.17:1935/hls/test</span></div></pre></td></tr></table></figure><p><code>注意</code>： 当我们进行推流之后，可以安装<a href="http://www.pc6.com/mac/112121.html" target="_blank" rel="external">VLC</a>、ffplay（支持rtmp协议的视频播放器）本地拉流进行演示</p><p>3.FFmpeg推流命令</p><p>① 视频文件进行直播</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ffmpeg -re -<span class="selector-tag">i</span> /Users/gao/Desktop/video/test<span class="selector-class">.mp4</span> -vcodec libx264 -vprofile baseline -acodec aac -ar <span class="number">44100</span> -strict -<span class="number">2</span> -ac <span class="number">1</span> -f flv  -<span class="selector-tag">q</span> <span class="number">10</span> rtmp:<span class="comment">//192.168.1.101:1935/hls/test</span></div><div class="line">ffmpeg -re -<span class="selector-tag">i</span> /Users/gao/Desktop/video/test<span class="selector-class">.mp4</span> -vcodec libx264 -vprofile baseline -acodec aac -ar <span class="number">44100</span> -strict -<span class="number">2</span> -ac <span class="number">1</span> -f flv  -<span class="selector-tag">q</span> <span class="number">10</span> rtmp:<span class="comment">//10.14.221.17:1935/hls/test</span></div></pre></td></tr></table></figure><p>② 推流摄像头＋桌面+麦克风录制进行直播</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ffmpeg -f avfoundation -framerate <span class="number">30</span> -<span class="selector-tag">i</span> <span class="string">"1:0"</span> \-f avfoundation -framerate <span class="number">30</span> -video_size <span class="number">640</span>x480 -<span class="selector-tag">i</span> <span class="string">"0"</span> \-c:v libx264 -preset ultrafast \-filter_complex <span class="string">'overlay=main_w-overlay_w-10:main_h-overlay_h-10'</span> -acodec libmp3lame -ar <span class="number">44100</span> -ac <span class="number">1</span>  -f flv rtmp:<span class="comment">//192.168.1.101:1935/hls/test</span></div></pre></td></tr></table></figure><p>更多命令，请参考：<br><a href="http://blog.csdn.net/leixiaohua1020/article/details/12029543" target="_blank" rel="external">FFmpeg处理RTMP流媒体的命令大全</a><br><a href="http://www.jianshu.com/p/d541b317f71c" target="_blank" rel="external">FFmpeg常用推流命令</a></p><h2 id="七、H5-直播视频播放" class="post-heading"><a href="#七、H5-直播视频播放" class="headerlink" title="七、H5 直播视频播放"></a>七、H5 直播视频播放<a class="post-anchor" href="#七、H5-直播视频播放" aria-hidden="true"></a></h2><p>移动端iOS和 Android 都天然支持HLS协议，做好视频采集端、视频流推流服务之后，便可以直接在H5页面配置 video 标签播放直播视频。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="selector-tag">video</span> controls preload=<span class="string">"auto"</span>  autoplay=<span class="string">"autoplay"</span> loop=<span class="string">"loop"</span> webkit-playsinline&gt;    </div><div class="line">    &lt;source src=<span class="string">"http://10.14.221.8/hls/test.m3u8"</span> type=<span class="string">"application/vnd.apple.mpegurl"</span> /&gt;  </div><div class="line">    &lt;<span class="selector-tag">p</span> class=<span class="string">"warning"</span>&gt;Your browser does not support HTML5 <span class="selector-tag">video</span>.&lt;/p&gt;  </div><div class="line">&lt;/video&gt;</div></pre></td></tr></table></figure><p><code>ps</code>：① video标签添加<code>webkit-playsinline</code>属性（iOS支持）是保证视频在网页中内嵌播放。<br>② 针对微信浏览器，video标签层级最高的问题，需要申请添加白名单，请参照 <a href="http://bbs.mb.qq.com/thread-1242581-1-1.html?ptlang=2052。" target="_blank" rel="external">http://bbs.mb.qq.com/thread-1242581-1-1.html?ptlang=2052。</a></p><h2 id="八、总结" class="post-heading"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结<a class="post-anchor" href="#八、总结" aria-hidden="true"></a></h2><p>本文从视频采集上传，服务器处理视频推流，以及H5页面播放直播视频一整套流程,具体阐述了直播实现原理，实现过程中会遇到很多性能优化问题。</p><p>① H5 HLS 限制必须是H264+AAC编码。</p><p>② H5 HLS 播放卡顿问题，server 端可以做好分片策略，将 ts 文件放在 CDN 上，前端可尽量做到 DNS 缓存等。</p><p>③ H5 直播为了达到更好的实时互动，也可以采用RTMP协议，通过<code>video.js</code>实现播放。</p><p>参考资料：</p><ul><li><a href="https://www.zhihu.com/question/42162310" target="_blank" rel="external">如何搭建一个完整的视频直播系统？</a></li><li><a href="http://www.haomou.net/2014/08/04/2014_Html5_canvas_video/" target="_blank" rel="external">WebRTC相关的canvas与video</a></li><li><a href="https://segmentfault.com/a/1190000000392586" target="_blank" rel="external">使用 WebSockets 进行 HTML5 视频直播</a></li><li><a href="http://blog.ucloud.cn/archives/694" target="_blank" rel="external">关于直播，所有的技术细节都在这里了（一）</a></li><li><a href="http://blog.ucloud.cn/archives/699" target="_blank" rel="external">关于直播，所有的技术细节都在这里了（二）</a></li><li><a href="http://blog.ucloud.cn/archives/760" target="_blank" rel="external">关于直播，所有的技术细节都在这里了（三）</a></li><li><a href="https://github.com/phoboslab/jsmpeg" target="_blank" rel="external">JS解码项目jsmpeg</a></li></ul><div class="post-tags" style="display:none"><a href="/tags/H5/">H5</a> <a href="/tags/H5-视频直播-video/">H5 视频直播 video</a> <a href="/tags/HLS、RTMP协议/">HLS、RTMP协议</a></div><div class="post-categories" style="display:none"><a href="/cates/Web开发/">Web开发</a></div><div class="post-announce">感谢您的阅读，本文由 <a href="//aotu.io">凹凸实验室</a> 版权所有。如若转载，请注明出处：凹凸实验室（<a href="https://aotu.io/notes/2016/10/09/HTML5-SopCast/">https://aotu.io/notes/2016/10/09/HTML5-SopCast/</a>）</div><div class="post-revision"><i class="fa fa-clock-o"></i> <time class="post-updated" datetime="2016-10-20T07:06:32.451Z">上次更新：2016-10-20 15:06:32</time></div></div><div class="post-nav"><div class="post-nav-next"><a href="/notes/2016/10/13/vue2/" title="Vue2.0 新手完全填坑攻略——从环境搭建到服务器渲染">Vue2.0 新手完全填坑攻略——从环境搭建到服务器渲染 <i class="fa fa-chevron-right"></i></a></div><div class="post-nav-prev"><a href="/notes/2016/10/08/aframe/" title="A-Frame WebVR试玩报告"><i class="fa fa-chevron-left"></i> A-Frame WebVR试玩报告</a></div></div><div class="post-comments" id="comments"><div class="ds-thread" data-thread-key="bm90ZXMvMjAxNi8xMC8wOS9IVE1MNS1Tb3BDYXN0Lw==" data-title="H5直播起航" data-url="https://aotu.io/notes/2016/10/09/HTML5-SopCast/index.html"></div><script type="text/javascript">var duoshuoQuery={short_name:"aotu"};!function(){var t=document.createElement("script");t.id="duoshuo-script",t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script></div></article></div><aside class="mod-side" id="sidebar"><div class="mod-side-sec aotuwx"><img class="aotuwx-qrcode" src="/img/qrcode.jpg" alt="关注我们"><div class="aotuwx-slogan">每周五推送精选技术文章</div></div><div class="mod-side-sec works"><div class="mod-side-sec-hd"><h2>服务/产品</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="//cases.aotu.io/mobi/maga.html" target="_blank" title="拇指期刊">拇指期刊</a></li><li><a href="//athena.aotu.io/" target="_blank" title="Athena">Athena</a></li><li><a href="//guide.aotu.io/" target="_blank" title="前端代码规范">前端代码规范</a></li><li><a href="//halojs.aotu.io/" target="_blank" title="HaloJS">HaloJS</a></li><li><a href="//sign.aotu.io/" target="_blank" title="邮件签名工具">邮件签名工具</a></li><li><a href="//mac.aotu.io/" target="_blank" title="MAC全栈环境">MAC全栈环境</a></li></ul></div></div><div class="mod-side-sec favlinks"><div class="mod-side-sec-hd"><h2>友情链接</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="https://jdc.jd.com" target="_blank" title="京东设计中心">JDC京东设计中心</a></li><li><a href="http://fex.baidu.com" target="_blank" title="百度Web前端研发部">百度FEX</a></li><li><a href="http://taobaofed.org" target="_blank" title="淘宝前端团队">淘宝FED</a></li><li><a href="http://tgideas.qq.com" target="_blank" title="腾讯互娱设计中心">TGIdeas</a></li><li><a href="http://isux.tencent.com" target="_blank" title="腾讯SNG设计中心">ISUX</a></li><li><a href="http://cdc.tencent.com" target="_blank" title="腾讯用户研究与体验设计中心">CDC</a></li><li><a href="http://ued.ctrip.com" target="_blank" title="携程设计委员会">携程UED</a></li></ul></div></div></aside></div></div><div class="mod-backtop" id="backTop"><i class="fa fa-long-arrow-up"></i></div><footer class="mod-ft" id="footer"><div class="grid"><ul class="mod-ft-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="https://github.com/o2team/o2team.github.io" target="_blank"><i class="fa fa-github-alt"></i></a></li></ul><div class="mod-ft-sec mod-ft-copyright"><p>Designed by <a href="http://aotu.io" target="_blank">凹凸实验室</a> @<a target="_blank" href="http://jdc.jd.com">京东用户体验设计部</a></p><p>Copyright &copy; 2016. All Rights Reserved.</p><p><a href="http://www.miibeian.gov.cn/" target="_blank">粤ICP备15077732号-2</a></p></div></div></footer><script src="/js/bundle/core.js"></script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e850b980d029480b092fdd7503c3f8de";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><style>#cnzz_stat_icon_1258539944{display:none}</style><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?" https://":" http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1258539944'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s11.cnzz.com/z_stat.php%3Fid%3D1258539944' type='text/javascript'%3E%3C/script%3E"))</script></body></html>