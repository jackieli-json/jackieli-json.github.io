<!DOCTYPE html><html class="theme-lattice"><head><meta charset="utf-8"><title>HTTP 缓存 | Aotu.io「凹凸实验室」</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="凹凸实验室"><meta name="designer" content="凹凸实验室"><meta name="rating" content="general"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="index, follow"><meta name="keywords" content="HTTP Cache 缓存 优化,凹凸实验室,Aotu,前端开发,全栈开发,IOS开发,Android开发"><link rel="canonical" href="https://aotu.io/notes/2016/09/22/http-caching/index.html"><link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="60x60" href="/img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png"><link rel="icon" type="image/png" href="/img/favicon-230x230.png" sizes="230x230"><link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16"><link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32"><meta name="msapplication-TileColor" content="#2f83cd"><meta name="msapplication-TileImage" content="/img/mstile-144x144.png"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="Aotu.io"><meta name="description" content="有时，HTTP 中的缓存可能会非常让人头疼。按照文档正确地使用 HTTP 并不是那么困难，但事实上，不同的浏览器和 HTTP 版本常常困扰着我们。"><meta property="og:type" content="article"><meta property="og:title" content="HTTP 缓存"><meta property="og:url" content="https://aotu.io/notes/2016/09/22/http-caching/index.html"><meta property="og:site_name" content="Aotu.io"><meta property="og:description" content="有时，HTTP 中的缓存可能会非常让人头疼。按照文档正确地使用 HTTP 并不是那么困难，但事实上，不同的浏览器和 HTTP 版本常常困扰着我们。"><meta property="og:updated_time" content="2016-10-20T07:06:32.449Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="HTTP 缓存"><meta name="twitter:description" content="有时，HTTP 中的缓存可能会非常让人头疼。按照文档正确地使用 HTTP 并不是那么困难，但事实上，不同的浏览器和 HTTP 版本常常困扰着我们。"><meta name="twitter:site" content="o2circle"><script>var App={root:"/",isHome:!1,isCate:!1,isTag:!1}</script></head><body class="page-post-detail"><div class="mod-hd"><div class="grid"><div class="mod-logo"><a href="/index.html" title="Aotu.io">Aotu.io</a></div><span class="mod-hd-toggle" id="J_hdToggle"><i class="fa fa-bars"></i></span><div class="mod-hd-main"><div class="mod-hd-inner"><nav class="mod-nav"><ul class="mod-nav-list"><li class="main-nav-item"><a href="/index.html" class="main-nav-link">首页</a></li><li class="main-nav-item"><a href="/about/" class="main-nav-link">关于</a></li><li class="main-nav-item"><a href="/join/" class="main-nav-link">加入我们</a></li></ul></nav><div class="mod-search"><a class="fa fa-search mod-search-ico" id="J_searchTrigger" title="搜索"></a><form id="J_searchForm" method="get" class="mod-search-form" action="/search/"><input type="text" name="query" class="mod-search-ipt" id="J_searchInput" placeholder="搜索"></form></div></div></div></div></div><div class="mod-container"><div class="grid"><div class="mod-main"><article class="post"><header class="post-hd"><h2 class="post-tit">HTTP 缓存</h2><div class="post-meta">by <a target="_blank" href="https://github.com/Calvin92" class="post-author">skillful-driver</a> on <span>2016-09-22</span></div><p class="post-subtit" style="display:none"><i class="fa fa-quote-left"></i>Web 开发离不开 HTTP 请求，大量的 HTTP 请求会导致大量的带宽和性能的损耗。那么，如何通过HTTP 缓存优化呢？</p><span style="display:none" id="busuanzi_value_page_pv"></span></header><div class="post-cover"><img src="//misc.aotu.io/chuyik/http_caching_900_500.png" alt="HTTP 缓存"></div><div class="post-content"><p>有时，HTTP 中的缓存可能会非常让人头疼。<br>按照文档正确地使用 HTTP 并不是那么困难，但事实上，不同的浏览器和 HTTP 版本常常困扰着我们。</p><a id="more"></a><p>通过 <a href="http://stackoverflow.com/search?q=http+cache" target="_blank" rel="external">Stack Overflow</a> 的搜索结果，你可以很轻易地发现很多人有相同的困扰。我们自己或是不必或是没有时间去钻研所有的边缘的情况。</p><p>所以这里有一些博主总结的实用并速记的规则，并且在未来博主也会持续地跟进和更新。</p><h2 id="静态资源" class="post-heading"><a href="#静态资源" class="headerlink" title="静态资源"></a>静态资源<a class="post-anchor" href="#静态资源" aria-hidden="true"></a></h2><p>永远不会修改的内容：JS 和 CSS 文件，图片，和任何类型的二进制文件都属于这个类目。</p><p>永远，我确实说的是永远。为静态资源指定版本号是很通用的做法。它们无论什么时候改动了，它们的 URL 就改变了。</p><p>这里是一些针对静态资源的简单的规则：</p><ul><li>在文件或者路径中嵌入指纹。避免为指纹使用查询字符串。另外，确保生成的URL长度超过8个不同的字符。</li><li>使用这些 HTTP 头：<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Cache-<span class="string">Control:</span> <span class="keyword">public</span>, max-age=<span class="number">31536000</span></div><div class="line"><span class="string">Expires:</span> (一年后的今天)</div><div class="line"><span class="string">ETag:</span> (基于内容生成)</div><div class="line">Last-<span class="string">Modified:</span> (过去某个时间)</div><div class="line"><span class="string">Vary:</span> Accept-Encoding</div></pre></td></tr></table></figure></li></ul><p>针对静态资源的设置就是那么简单。</p><h2 id="动态资源" class="post-heading"><a href="#动态资源" class="headerlink" title="动态资源"></a>动态资源<a class="post-anchor" href="#动态资源" aria-hidden="true"></a></h2><p>针对应用程序私密性和新鲜度方面需求的不同，我们应该使用不同的缓存控制设置。</p><p>对于非私密性和经常性变动的资源（想像一下股票信息），我们应该使用下面这些：<br></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Cache-<span class="string">Control:</span> <span class="keyword">public</span>, max-age=<span class="number">0</span></div><div class="line"><span class="string">Expires:</span> (当前时间)</div><div class="line"><span class="string">ETag:</span> (基于内容生成)</div><div class="line">Last-<span class="string">Modified:</span> (过去某个时间)</div><div class="line"><span class="string">Vary:</span> Accept-Encoding</div></pre></td></tr></table></figure><p></p><p>这些设置的效果是：这些资源可以被公开地（通过浏览器和代理服务器）缓存起来。每一次在浏览器使用这些资源之前，浏览器或者代理服务器会检查这些资源是否有更新的版本，如果有，就把它们下载下来。</p><p>这样的设置需要注意，浏览器在重新检查资源时效性方面有一定的灵活性。典型的是，当用户点击了「返回／前进」按钮时，浏览器不会重新检查这些资源文件，而是直接使用缓存的版本。你如果需要更严格的控制，需要告知浏览器即使当用户点击了「返回／前进」按钮，也需要重新检查这些资源文件，那么可以使用：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Cache</span>-Control: <span class="keyword">public</span>, <span class="keyword">no</span>-<span class="keyword">cache</span>, <span class="keyword">no</span>-<span class="keyword">store</span></div></pre></td></tr></table></figure><p></p><p>不是所有的动态资源都会马上变成过时的资源。如果它们可以保持至少5分钟的时效，可以使用：<br></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Cache</span><span class="params">-Control</span>: <span class="keyword">public</span>, <span class="keyword">max</span><span class="params">-age</span>=<span class="number">300</span></div></pre></td></tr></table></figure><p></p><p>经过这样的设置，浏览器只会在5分钟之后才重新检查。在这之前，缓存的内容会被直接使用。如果在5分钟后，这些过时的内容需要严格控制，你可以添加 <code>must-revalidate</code> 字段：<br></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Cache</span><span class="params">-Control</span>: <span class="keyword">public</span>, <span class="keyword">max</span><span class="params">-age</span>=<span class="number">300</span>, must<span class="params">-revalidate</span></div></pre></td></tr></table></figure><p></p><p>对于私密或者针对用户的内容，需要把 <code>public</code> 替换为 <code>private</code> 以避免内容被代理缓存。<br></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache-<span class="string">Control:</span> <span class="keyword">private</span>, …</div></pre></td></tr></table></figure><p></p><h2 id="Cache-Control-和-Expires" class="post-heading"><a href="#Cache-Control-和-Expires" class="headerlink" title="Cache-Control 和 Expires"></a>Cache-Control 和 Expires<a class="post-anchor" href="#Cache-Control-和-Expires" aria-hidden="true"></a></h2><p>当同时使用 <code>Cache-Control</code> 和 <code>Expires</code> 时，<code>Cache-Control</code> 获得优先权。</p><p>同时使用 <code>Cache-Control</code> 和 <code>Expires</code> 意味着得到更广泛的支持（被不同的浏览器和版本）。当然，它们两个应该被配置成相同的时效值，以避免引起困惑。</p><blockquote><p>参考 <a href="http://squid-web-proxy-cache.1019090.n4.nabble.com/Expires-vs-Cache-Control-max-age-td1033350.html" target="_blank" rel="external">Expires: vs. Cache-Control: max-age</a></p></blockquote><h2 id="ETag-和-Last-Modified" class="post-heading"><a href="#ETag-和-Last-Modified" class="headerlink" title="ETag 和 Last-Modified"></a>ETag 和 Last-Modified<a class="post-anchor" href="#ETag-和-Last-Modified" aria-hidden="true"></a></h2><p>这两个头在浏览器对资源做重新检查验证的时候会使用到。大致来说，浏览器只是盲目地存储这两个来自于服务器的头的值，然后在需要检查验证的时候，浏览器根据请求条件，把这两个指发送给服务器（分别通过 <code>If-None-Match</code> 和 <code>If-Modified-Since</code>）。</p><p>注意只有在资源过期的情况下，检查验证才会发生。</p><p>在有条件的请求下，<code>If-None-Match</code> 和 <code>If-Modified-Since</code> 头的出现取决于服务器。然而，由于是服务器生成的 <code>ETag</code> 和（或） <code>Last-Modified</code>，所以实际上，这没有什么大问题。大多数的浏览器在可能的情况下都会把着两者都发送给服务器。</p><blockquote><p>参考 <a href="http://stackoverflow.com/questions/824152/what-takes-precedence-the-etag-or-last-modified-http-header" target="_blank" rel="external">What takes precedence: the ETag or Last-Modified HTTP header?</a></p></blockquote><p>一个通常的建议是：避免使用 <code>ETag</code>。这不是一个总是有用的建议。<code>ETag</code> 在判断内容是否真的改动方面确实提供了更为精确的控制。针对生成的 <code>ETag</code>，默认的Apache方法需要把文件的索引节（inode），大小（size）和最后修改时间作为输入求值得到。这会导致在负载均衡的环境中，生成的 <code>ETag</code> 值变得毫无用处，因为每个服务器都会针对相同的文件生成一个不同的 <code>Etag</code> 值。这个可能就是唯一的问题导致很多人完全禁用 <code>ETag</code>，其实只要精确地针对一个匹配的文件生成一个独一无二的 <code>ETag</code> 值，就没有必要禁用 <code>ETag</code> 了。</p><blockquote><p>参考 <a href="https://www.techpunch.co.uk/development/should-your-site-be-using-etags-or-not" target="_blank" rel="external">Should your site be using etags or not?</a></p></blockquote><h2 id="手动按下-Ctrl-R" class="post-heading"><a href="#手动按下-Ctrl-R" class="headerlink" title="手动按下 Ctrl-R"></a>手动按下 Ctrl-R<a class="post-anchor" href="#手动按下-Ctrl-R" aria-hidden="true"></a></h2><p>当按下 <code>Ctrl-R</code> 时，浏览器会携带下面的请求，以检查是否需要更新缓存内容：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Cache</span>-Control: <span class="keyword">max</span>-age=<span class="number">0</span></div><div class="line"><span class="keyword">If</span>-<span class="keyword">None</span>-<span class="keyword">Match</span>: …</div><div class="line"><span class="keyword">If</span>-Modifed-Since: …</div></pre></td></tr></table></figure><p></p><p>注意这并不只是和原服务器建立连接，其同样适用于代理服务器。本质上，它只是重新检查验证内容。如果服务器回应了一个304，浏览器将会使用缓存的内容。</p><h2 id="Vary-Accept-Encoding" class="post-heading"><a href="#Vary-Accept-Encoding" class="headerlink" title="Vary: Accept-Encoding"></a>Vary: Accept-Encoding<a class="post-anchor" href="#Vary-Accept-Encoding" aria-hidden="true"></a></h2><p>这个头对于一些人来说可能比较陌生。</p><p>当一个资源启用了 gzip 压缩，并且被代理服务器缓存，客户端如果不支持 gzip 压缩，那么在这样的情况下将会得到不正确的数据（也就是，压缩过的数据）。这将会使代理服务器缓存两个版本的资源：一个是压缩过的，一个是没压缩过的。正确版本的资源将在请求头发送之后进行传输。</p><p>还有一个现实的原因：IE 浏览器不缓存任何带有 <code>Vary</code> 头但值不为 <code>Accept-Encoding</code> 和 <code>User-Agent</code> 的资源。所以通过这种方式添加这个头，才能确保这些资源在 IE 下被缓存。</p><blockquote><p>本文译自 Bryan Tsai 的 《<a href="https://bryantsai.com/http-caching/" target="_blank" rel="external">Http Caching</a>》。</p></blockquote><h2 id="参考资料" class="post-heading"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料<a class="post-anchor" href="#参考资料" aria-hidden="true"></a></h2><ul><li><a href="https://devcenter.heroku.com/articles/increasing-application-performance-with-http-cache-headers" target="_blank" rel="external">Increasing Application Performance with HTTP Cache Headers</a></li><li><a href="http://tomayko.com/writings/things-caches-do" target="_blank" rel="external">Things Caches Do</a></li><li><a href="https://developers.google.com/speed/articles/caching" target="_blank" rel="external">Google Developers: HTTP Caching</a></li><li><a href="https://developers.google.com/speed/docs/best-practices/caching?csw=1" target="_blank" rel="external">Google Developers: Optimize Caching</a></li><li><a href="http://www.mnot.net/cache_docs/" target="_blank" rel="external">Caching Tutorial for Web Authors and Webmasters</a></li><li><a href="http://palizine.plynt.com/issues/2008Jul/cache-control-attributes/" target="_blank" rel="external">Cache Control Directives Demystified</a></li><li><a href="http://webmasters.stackexchange.com/questions/1459/what-are-the-hard-and-fast-rules-for-cache-control?lq=1" target="_blank" rel="external">What are the hard and fast rules for Cache Control?</a></li><li><a href="http://stackoverflow.com/questions/1046966/whats-the-difference-between-cache-control-max-age-0-and-no-cache" target="_blank" rel="external">What’s the difference between Cache-Control: max-age=0 and no-cache?</a></li><li><a href="http://stackoverflow.com/questions/2932890/http-cache-control-max-age-must-revalidate" target="_blank" rel="external">HTTP Cache Control max-age, must-revalidate</a></li><li><a href="http://stackoverflow.com/questions/18148884/difference-between-no-cache-and-must-revalidate?rq=1" target="_blank" rel="external">Difference between no-cache and must-revalidate</a></li><li><a href="http://blogs.msdn.com/b/ie/archive/2010/07/14/caching-improvements-in-internet-explorer-9.aspx" target="_blank" rel="external">Caching Improvements in Internet Explorer 9</a></li></ul><div class="post-tags" style="display:none"><a href="/tags/HTTP-Cache-缓存-优化/">HTTP Cache 缓存 优化</a></div><div class="post-categories" style="display:none"><a href="/cates/Web开发/">Web开发</a></div><div class="post-announce">感谢您的阅读，本文由 <a href="//aotu.io">凹凸实验室</a> 版权所有。如若转载，请注明出处：凹凸实验室（<a href="https://aotu.io/notes/2016/09/22/http-caching/">https://aotu.io/notes/2016/09/22/http-caching/</a>）</div><div class="post-revision"><i class="fa fa-clock-o"></i> <time class="post-updated" datetime="2016-10-20T07:06:32.449Z">上次更新：2016-10-20 15:06:32</time></div></div><div class="post-nav"><div class="post-nav-next"><a href="/notes/2016/09/28/3d-touch/" title="在网页上实现 3D Touch 效果">在网页上实现 3D Touch 效果 <i class="fa fa-chevron-right"></i></a></div><div class="post-nav-prev"><a href="/notes/2016/09/22/es6-import-with-babel/" title="通过 Babel 使用 ES6 的 import"><i class="fa fa-chevron-left"></i> 通过 Babel 使用 ES6 的 import</a></div></div><div class="post-comments" id="comments"><div class="ds-thread" data-thread-key="bm90ZXMvMjAxNi8wOS8yMi9odHRwLWNhY2hpbmcv" data-title="HTTP 缓存" data-url="https://aotu.io/notes/2016/09/22/http-caching/index.html"></div><script type="text/javascript">var duoshuoQuery={short_name:"aotu"};!function(){var t=document.createElement("script");t.id="duoshuo-script",t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script></div></article></div><aside class="mod-side" id="sidebar"><div class="mod-side-sec aotuwx"><img class="aotuwx-qrcode" src="/img/qrcode.jpg" alt="关注我们"><div class="aotuwx-slogan">每周五推送精选技术文章</div></div><div class="mod-side-sec works"><div class="mod-side-sec-hd"><h2>服务/产品</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="//cases.aotu.io/mobi/maga.html" target="_blank" title="拇指期刊">拇指期刊</a></li><li><a href="//athena.aotu.io/" target="_blank" title="Athena">Athena</a></li><li><a href="//guide.aotu.io/" target="_blank" title="前端代码规范">前端代码规范</a></li><li><a href="//halojs.aotu.io/" target="_blank" title="HaloJS">HaloJS</a></li><li><a href="//sign.aotu.io/" target="_blank" title="邮件签名工具">邮件签名工具</a></li><li><a href="//mac.aotu.io/" target="_blank" title="MAC全栈环境">MAC全栈环境</a></li></ul></div></div><div class="mod-side-sec favlinks"><div class="mod-side-sec-hd"><h2>友情链接</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="https://jdc.jd.com" target="_blank" title="京东设计中心">JDC京东设计中心</a></li><li><a href="http://fex.baidu.com" target="_blank" title="百度Web前端研发部">百度FEX</a></li><li><a href="http://taobaofed.org" target="_blank" title="淘宝前端团队">淘宝FED</a></li><li><a href="http://tgideas.qq.com" target="_blank" title="腾讯互娱设计中心">TGIdeas</a></li><li><a href="http://isux.tencent.com" target="_blank" title="腾讯SNG设计中心">ISUX</a></li><li><a href="http://cdc.tencent.com" target="_blank" title="腾讯用户研究与体验设计中心">CDC</a></li><li><a href="http://ued.ctrip.com" target="_blank" title="携程设计委员会">携程UED</a></li></ul></div></div></aside></div></div><div class="mod-backtop" id="backTop"><i class="fa fa-long-arrow-up"></i></div><footer class="mod-ft" id="footer"><div class="grid"><ul class="mod-ft-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="https://github.com/o2team/o2team.github.io" target="_blank"><i class="fa fa-github-alt"></i></a></li></ul><div class="mod-ft-sec mod-ft-copyright"><p>Designed by <a href="http://aotu.io" target="_blank">凹凸实验室</a> @<a target="_blank" href="http://jdc.jd.com">京东用户体验设计部</a></p><p>Copyright &copy; 2016. All Rights Reserved.</p><p><a href="http://www.miibeian.gov.cn/" target="_blank">粤ICP备15077732号-2</a></p></div></div></footer><script src="/js/bundle/core.js"></script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e850b980d029480b092fdd7503c3f8de";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><style>#cnzz_stat_icon_1258539944{display:none}</style><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?" https://":" http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1258539944'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s11.cnzz.com/z_stat.php%3Fid%3D1258539944' type='text/javascript'%3E%3C/script%3E"))</script></body></html>