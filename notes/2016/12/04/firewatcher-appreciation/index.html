<!DOCTYPE html><html class="theme-lattice"><head><meta charset="utf-8"><title>源码赏析 - 1K的Firewatch游戏 | 西门互联「西门互联」</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="西门互联"><meta name="designer" content="西门互联"><meta name="rating" content="general"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="index, follow"><meta name="keywords" content="js1k 游戏 3D,西门互联,前端,个人博客"><link rel="canonical" href="https://demo.lilidong.cn/notes/2016/12/04/firewatcher-appreciation/index.html"><link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="60x60" href="/img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png"><link rel="icon" type="image/png" href="/img/favicon-230x230.png" sizes="230x230"><link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16"><link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32"><meta name="msapplication-TileColor" content="#2f83cd"><meta name="msapplication-TileImage" content="/img/mstile-144x144.png"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="西门互联"><meta name="description" content="前言讲真，做前端越久，我们就越容易被思维所束缚。比如，应该没几个人会相信用1K代码能够写出一个游戏，而且还是3d的游戏。
在看这段代码之前我们不得不提到一个一年一度的比赛：js1k。每年，主办方会提出一个比赛主题，参赛者们必须围绕这个主题，用1024个字节以内的JS代码做一个参赛作品。比赛的要求有以下几个：

Create a fancy pancy JavaScript demo (用JS做出一"><meta property="og:type" content="article"><meta property="og:title" content="源码赏析 - 1K的Firewatch游戏"><meta property="og:url" content="https://demo.lilidong.cn/notes/2016/12/04/firewatcher-appreciation/index.html"><meta property="og:site_name" content="西门互联"><meta property="og:description" content="前言讲真，做前端越久，我们就越容易被思维所束缚。比如，应该没几个人会相信用1K代码能够写出一个游戏，而且还是3d的游戏。
在看这段代码之前我们不得不提到一个一年一度的比赛：js1k。每年，主办方会提出一个比赛主题，参赛者们必须围绕这个主题，用1024个字节以内的JS代码做一个参赛作品。比赛的要求有以下几个：

Create a fancy pancy JavaScript demo (用JS做出一"><meta property="og:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-thetop2.jpg"><meta property="og:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-gameui.jpg"><meta property="og:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-eventloop.png"><meta property="og:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-calcdist.jpg"><meta property="og:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-example.jpg"><meta property="og:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-tree.png"><meta property="og:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-smoke.png"><meta property="og:updated_time" content="2016-12-22T09:53:25.577Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="源码赏析 - 1K的Firewatch游戏"><meta name="twitter:description" content="前言讲真，做前端越久，我们就越容易被思维所束缚。比如，应该没几个人会相信用1K代码能够写出一个游戏，而且还是3d的游戏。
在看这段代码之前我们不得不提到一个一年一度的比赛：js1k。每年，主办方会提出一个比赛主题，参赛者们必须围绕这个主题，用1024个字节以内的JS代码做一个参赛作品。比赛的要求有以下几个：

Create a fancy pancy JavaScript demo (用JS做出一"><meta name="twitter:image" content="https://demo.lilidong.cn//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-thetop2.jpg"><meta name="twitter:site" content="o2circle"><script>var App={root:"/",isHome:!1,isCate:!1,isTag:!1}</script></head><body class="page-post-detail"><div class="mod-hd"><div class="grid"><div class="mod-logo"><a href="/index.html" title="西门互联">西门互联</a></div><span class="mod-hd-toggle" id="J_hdToggle"><i class="fa fa-bars"></i></span><div class="mod-hd-main"><div class="mod-hd-inner"><nav class="mod-nav"><ul class="mod-nav-list"><li class="main-nav-item"><a href="/index.html" class="main-nav-link">首页</a></li><li class="main-nav-item"><a href="/about/" class="main-nav-link">关于</a></li><li class="main-nav-item"><a href="/join/" class="main-nav-link">加入</a></li></ul></nav><div class="mod-search"><a class="fa fa-search mod-search-ico" id="J_searchTrigger" title="搜索"></a><form id="J_searchForm" method="get" class="mod-search-form" action="/search/"><input type="text" name="query" class="mod-search-ipt" id="J_searchInput" placeholder="搜索"></form></div></div></div></div></div><div class="mod-container"><div class="grid"><div class="mod-main"><article class="post"><header class="post-hd"><h2 class="post-tit">源码赏析 - 1K的Firewatch游戏</h2><div class="post-meta">by <a target="_blank" href="https://github.com/Littly" class="post-author">Littly</a> on <span>2016-12-04</span></div><p class="post-subtit" style="display:none"><i class="fa fa-quote-left"></i>逗我呢！1K的代码能干啥？JQ都不够吧！</p><span style="display:none" id="busuanzi_value_page_pv"></span></header><div class="post-cover"><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-900x500.jpg" alt="源码赏析 - 1K的Firewatch游戏"></div><div class="post-content"><h3 id="前言" class="post-heading"><a href="#前言" class="headerlink" title="前言"></a>前言<a class="post-anchor" href="#前言" aria-hidden="true"></a></h3><p>讲真，做前端越久，我们就越容易被思维所束缚。比如，应该没几个人会相信用1K代码能够写出一个游戏，而且还是3d的游戏。</p><p>在看这段代码之前我们不得不提到一个一年一度的比赛：<a href="http://js1k.com" target="_blank" rel="external">js1k</a>。每年，主办方会提出一个比赛主题，参赛者们必须围绕这个主题，用1024个字节以内的JS代码做一个参赛作品。比赛的要求有以下几个：</p><ul><li><p><strong>Create a fancy pancy JavaScript demo</strong> (用JS做出一个华丽的demo)</p></li><li><p><strong>Submissions may be up to 1024 bytes</strong> (最多1024字节)</p></li><li><p><strong>Externals are strictly forbidden</strong> (禁止引用外部资源)</p></li><li><p><strong>Must work current generation browsers</strong> (必须能在现代浏览器中运行)</p></li><li><p><strong>Minification and hacks allowed</strong> (允许代码压缩或者hack)</p></li></ul><p>另外，作为基础，demo运行的环境中<strong>内置了一部分变量</strong>供调用：</p><ul><li><p><code>window.a</code> 是一个canvas元素</p></li><li><p><code>window.b</code> 是document.body</p></li><li><p><code>window.c</code> 是a元素对应的2D/3D上下文</p></li><li><p><code>window.d</code> 是document对象</p></li></ul><p>是不是还挺贴心？只需要用一个字母就可以调用原本一长串代码才能拿到的对象喔。</p><p>除了这些，比赛还有一些小规则，可以查看比赛的 <a href="http://js1k.com/2016-elemental/rules" target="_blank" rel="external">规则页</a> ，里面有详细描述，这里就不再多说。</p><p>今年比赛的主题是 <strong>Let’s get eleMental!</strong>，我们今天要看的 <a href="http://js1k.com/2016-elemental/demo/2512" target="_blank" rel="external">Firewatch</a> 就是其中第三位的作品（第一名作品是 <a href="http://js1k.com/2016-elemental/demo/2552" target="_blank" rel="external">Romanesco 2.0</a> 3D分形展示，有强烈的不明觉厉感，建议前往围观；第二名 <a href="http://js1k.com/2016-elemental/demo/2497" target="_blank" rel="external">Voxeling</a> 是一个3D像素Demo）。</p><p><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-thetop2.jpg" alt="前二甲作品"></p><h3 id="Demo介绍" class="post-heading"><a href="#Demo介绍" class="headerlink" title="Demo介绍"></a>Demo介绍<a class="post-anchor" href="#Demo介绍" aria-hidden="true"></a></h3><p>游戏通过键盘<strong>上下左右+空格键</strong>操作。在开始游戏后，面前会有一颗烟花炸开。紧接着烟花下的树开始着火。玩家的任务就是按下空格，用水枪将火扑灭。在一定时间后，树上的火还会点燃周围的树。如果不慎走神，很有可能就救不回这片森林了喔。</p><p><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-gameui.jpg" alt="游戏画面"></p><h3 id="源码解析" class="post-heading"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析<a class="post-anchor" href="#源码解析" aria-hidden="true"></a></h3><p>粗略地讲，这份源码总共就分为两个部分：</p><ol><li><strong>创建对象</strong></li><li>绑定用户交互，进行<strong>事件循环</strong></li></ol><h4 id="创建对象" class="post-heading"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象<a class="post-anchor" href="#创建对象" aria-hidden="true"></a></h4><p>下面是创建对象部分的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// add trees</span></div><div class="line"><span class="keyword">for</span> (entities = [playerA = <span class="number">256</span>]; s = playerX = playerZ = playerA--;)</div><div class="line">    <span class="keyword">for</span> (</div><div class="line">        <span class="comment">// create trunk</span></div><div class="line">        entities.push(&#123;</div><div class="line">          <span class="attr">c</span>: [i = <span class="number">12</span>, <span class="number">60</span>, <span class="number">30</span>],</div><div class="line">          <span class="attr">x</span>: X = <span class="built_in">Math</span>.sqrt(playerA) * <span class="number">12</span> * <span class="built_in">Math</span>.cos(playerA) + <span class="built_in">Math</span>.random() * <span class="number">12</span>,</div><div class="line">          <span class="attr">h</span>: <span class="number">1</span>,</div><div class="line">          <span class="attr">y</span>: Y = <span class="built_in">Math</span>.random() * <span class="number">3</span> - <span class="number">1</span>,</div><div class="line">          <span class="attr">z</span>: Z = <span class="built_in">Math</span>.sqrt(playerA) * <span class="number">12</span> * <span class="built_in">Math</span>.sin(playerA) + <span class="built_in">Math</span>.random() * <span class="number">12</span>,</div><div class="line">          <span class="attr">s</span>: <span class="number">2</span>,</div><div class="line">          <span class="attr">S</span>: Y * <span class="number">2</span> + <span class="number">16</span></div><div class="line">        &#125;);</div><div class="line">        i--;</div><div class="line">        <span class="comment">// create leaf</span></div><div class="line">        entities.push(&#123;</div><div class="line">          <span class="attr">c</span>: [<span class="number">150</span>, <span class="number">60</span>, i * <span class="number">2</span>],</div><div class="line">          <span class="attr">x</span>: X + f * <span class="built_in">Math</span>.cos(e = <span class="built_in">Math</span>.random() * <span class="number">7</span>),</div><div class="line">          <span class="attr">z</span>: Z + f * <span class="built_in">Math</span>.sin(e),</div><div class="line">          <span class="attr">h</span>: <span class="number">860</span>,</div><div class="line">          <span class="attr">y</span>: Y - i / <span class="number">2</span> + <span class="number">10</span>,</div><div class="line">          <span class="attr">s</span>: <span class="number">8</span></div><div class="line">        &#125;)</div><div class="line">    )</div><div class="line">      <span class="comment">// create fallen fruit</span></div><div class="line">      f = <span class="built_in">Math</span>.random() * <span class="number">7</span>,</div><div class="line">      i % <span class="number">2</span> || entities.push(&#123;</div><div class="line">        <span class="attr">c</span>: [<span class="number">50</span>, <span class="number">60</span>, i * <span class="number">2</span>],</div><div class="line">        <span class="attr">x</span>: X + f * <span class="built_in">Math</span>.cos(e = <span class="built_in">Math</span>.random() * <span class="number">7</span>),</div><div class="line">        <span class="attr">z</span>: Z + f * <span class="built_in">Math</span>.sin(e),</div><div class="line">        <span class="attr">h</span>: <span class="number">860</span>,</div><div class="line">        <span class="attr">y</span>: <span class="number">-8</span>,</div><div class="line">        <span class="attr">s</span>: <span class="number">1</span></div><div class="line">      &#125;);</div><div class="line"><span class="comment">// burn a leaf (doubles as object for active keys)</span></div><div class="line">entities[<span class="number">30</span>].p = burn = <span class="function"><span class="keyword">function</span> (<span class="params">e, f</span>) </span>&#123;</div><div class="line">  <span class="comment">// update fire</span></div><div class="line">  e.h--;</div><div class="line">  e.c = [<span class="built_in">Math</span>.random() * <span class="number">60</span>, <span class="number">100</span>, <span class="number">0</span>],</div><div class="line">  e.s = <span class="built_in">Math</span>.random() * <span class="number">5</span> + <span class="number">6</span>,</div><div class="line"></div><div class="line">  <span class="comment">// create smoke / fireworks</span></div><div class="line">  s % <span class="number">16</span> || entities.push(&#123;</div><div class="line">    <span class="attr">c</span>: [<span class="number">0</span>, <span class="number">0</span>, e.w ? <span class="number">-30</span> : <span class="number">10</span>],</div><div class="line">    <span class="attr">x</span>: e.x + <span class="built_in">Math</span>.random() * <span class="number">6</span>,</div><div class="line">    <span class="attr">y</span>: e.y,</div><div class="line">    <span class="attr">z</span>: e.z,</div><div class="line">    <span class="attr">h</span>: <span class="number">90</span>,</div><div class="line">    <span class="attr">v</span>: <span class="number">60</span>,</div><div class="line">    <span class="attr">p</span>:</div><div class="line">      s ? <span class="function"><span class="keyword">function</span> (<span class="params">e, f</span>) </span>&#123;</div><div class="line">        e.h--;</div><div class="line">        e.y += <span class="number">.5</span></div><div class="line">      &#125; : <span class="function"><span class="keyword">function</span> (<span class="params">e, f</span>) </span>&#123;</div><div class="line">        e.h--;</div><div class="line">        e.c = [<span class="built_in">Math</span>.random() * <span class="number">60</span>, <span class="number">100</span>, <span class="number">0</span>],</div><div class="line">        e.h &lt; <span class="number">12</span> ? e.s += <span class="number">3</span> : e.y += <span class="number">3</span></div><div class="line">      &#125;,</div><div class="line">    <span class="attr">s</span>: <span class="number">4</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// spread fire</span></div><div class="line">  entities.some(<span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span>(s % <span class="number">300</span> || f.s == <span class="number">8</span> &amp;&amp; <span class="built_in">Math</span>.abs(e.x - f.x) + <span class="built_in">Math</span>.abs(e.z - f.z) &lt; <span class="number">40</span> &amp;&amp; <span class="built_in">Math</span>.random() * <span class="number">50</span> &lt; <span class="number">1</span> &amp;&amp; (f.p = burn))</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  e.w = <span class="number">0</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>为了减少代码占用的空间，作者大量使用了单字母的变量名与属性名，比如<code>entities.c</code>，<code>entities.x</code>等等，代码可读性非常差。</p><p>浏览一遍，我们是根本看不出上面这些变量是什么含义了。</p><p>但是，我们能够确定的是，这段代码初始化了<code>playerA</code>，<code>playerX</code>，<code>playerZ</code>变量，然后把所有的对象设定好属性后都存入了<code>entities</code>数组中，包括树干，树底下的水果，还有树干等等。没办法，只能先跳过这部分了。</p><h4 id="用户交互" class="post-heading"><a href="#用户交互" class="headerlink" title="用户交互"></a>用户交互<a class="post-anchor" href="#用户交互" aria-hidden="true"></a></h4><p>这是代码中主管用户交互的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">onkeydown = onkeyup = <span class="function"><span class="keyword">function</span> (<span class="params">e, f</span>) </span>&#123;</div><div class="line">  burn[e.keyCode - <span class="number">32</span>] = e.type[<span class="number">5</span>]</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>蛤？就这么短？</p><p>…</p><p><strong>真是这么短。</strong></p><p>上面这段代码，看着更像是定义了onkeydown跟onkeyup俩函数，后面理应还有类似于addEventListener之类的语句将这个函数绑定给某个元素某个事件的代码。因为身为前端，我们早已习惯绑定事件的那几种套路：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DomEl.addEventListener(eventname, callback); <span class="comment">// webkit</span></div><div class="line">DomEl.attachEvent(eventname, callback); <span class="comment">// IE</span></div><div class="line">$.bind(eventname, callback); <span class="comment">// jQ</span></div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure><p>可是任凭老司机怎么 Ctrl+f 搜索代码，也并没有找到所谓的绑定事件的语句。</p><p>事实上，作者在定义这两个函数的时候，并没有使用var关键字。意味着，这后面定义的变量，是直接挂在window下的。那么凭空定义的这两个函数，就分别会变成 <code>window.onkeydown</code> 和 <code>window.onkeyup</code> 。没错，这就是我们<strong>极度不推崇的绑定回调的方式</strong>了。</p><p>回调函数的内容，是在用户按下按键的时候将burn中下标为 <code>keyCode - 32</code> 的属性设定为 <code>keydown</code> 或者 <code>keyup</code> 的第六个字母，也就是 <code>w</code> 或者 <code>undefined</code> 。这个做法十分精妙，下面举例说明。</p><p>假设我们按下了空格键（keyCode=32），执行 <code>onkeydown</code> 函数，<code>burn[0] = &#39;w&#39;</code>；而放手的时候，则执行 <code>onkeyup</code> 函数， <code>burn[0] = undefined</code> 。这样一来，在事件循环里面只需要判断<code>burn[0]</code>是<code>true</code>还是<code>false</code>，就可以知道空格键按下了没有。同理，<code>burn[5]</code>，<code>burn[6]</code>，<code>burn[7]</code>，<code>burn[8]</code>分别代表了左，上，右，下键的状态。</p><p>可是，印象中burn是个函数呀，<code>entities[30].p = burn = function (e, f) {...}</code>，怎么就用来表示按键状态了呢？目的只能有一个，省下一个声明变量的语句。</p><p><strong>为了省下多几个字符，程序员真是什么事都做得出来啊…</strong></p><h4 id="事件循环" class="post-heading"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环<a class="post-anchor" href="#事件循环" aria-hidden="true"></a></h4><p>终于到了事件循环部分了。这部分代码占了源码大概一半的篇幅。折叠后，代码结构大概是这样的：</p><p><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-eventloop.png" alt="事件循环"></p><p>结构大概清晰了：首先是玩家的移动，接着是水枪的处理，紧接着是背景天空森林地板的渲染。</p><p>每个事件循环一开始，先是移动玩家。<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// move player</span></div><div class="line">playerA += (!!burn[<span class="number">7</span>] - !!burn[<span class="number">5</span>]) / <span class="number">20</span>,</div><div class="line">playerX += (e = !!burn[<span class="number">6</span>] - !!burn[<span class="number">8</span>]) * <span class="built_in">Math</span>.sin(playerA),</div><div class="line">playerZ += e * <span class="built_in">Math</span>.cos(playerA),</div></pre></td></tr></table></figure><p></p><p>理解了用户交互部分的内容，这里就很好理解了。burn[5]与burn[7]分管左右两键，那么<code>playerA</code>很明显就是用户的朝向。而burn[6]与burn[8]分管前后，在经过换算后，我们很快也就能知道<code>playerX</code>与<code>playerZ</code>分别是玩家在<strong>x-z平面上</strong>的坐标。别忘了这游戏可是3D的，所以并不用x-y坐标系。</p><p>接下来是水枪的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// discharge water</span></div><div class="line">burn[<span class="number">0</span>] &amp;&amp; entities.push(&#123;</div><div class="line">  <span class="attr">c</span>: [<span class="number">200</span>, <span class="number">60</span>, <span class="number">-5</span> * <span class="built_in">Math</span>.sin(s)],</div><div class="line">  <span class="attr">x</span>: playerX + <span class="number">12</span> * <span class="built_in">Math</span>.cos(playerA),</div><div class="line">  <span class="attr">z</span>: playerZ - <span class="number">12</span> * <span class="built_in">Math</span>.sin(playerA),</div><div class="line">  <span class="attr">e</span>: playerA - <span class="number">.5</span>,</div><div class="line">  <span class="attr">s</span>: <span class="number">2</span>,</div><div class="line">  <span class="attr">h</span>: <span class="number">20</span>,</div><div class="line">  <span class="attr">p</span>: <span class="function"><span class="keyword">function</span> (<span class="params">e, f</span>) </span>&#123;</div><div class="line">    e.h--;</div><div class="line">    e.x += <span class="number">2</span> * <span class="built_in">Math</span>.sin(e.e),</div><div class="line">    e.z += <span class="number">2</span> * <span class="built_in">Math</span>.cos(e.e),</div><div class="line">    e.y = <span class="number">5</span> - (e.h / <span class="number">2</span> - <span class="number">5</span>) * (e.h / <span class="number">2</span> - <span class="number">5</span>) / <span class="number">2</span>,</div><div class="line">    entities.some(<span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</div><div class="line">      f.p == burn &amp;&amp; <span class="built_in">Math</span>.abs(e.x - f.x) + <span class="built_in">Math</span>.abs(e.z - f.z) &lt; e.s / <span class="number">2</span> + f.s / <span class="number">2</span> &amp;&amp; (</div><div class="line">        f.h -= f.w = <span class="number">9</span></div><div class="line">      )</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>只要空格被按下，就会有新的对象被插入<code>entities</code>数组中。不过既然是水枪的代码，我们很容易可以想到，这里插进去的对象正是水流。</p><p>水流浇到火上是可以灭火的，所以下面这段带有一堆abs的代码，十有八九是用来<strong>判断水流跟火焰的位置关系</strong>的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">entities.some(<span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</div><div class="line">  f.p == burn &amp;&amp; <span class="built_in">Math</span>.abs(e.x - f.x) + <span class="built_in">Math</span>.abs(e.z - f.z) &lt; e.s / <span class="number">2</span> + f.s / <span class="number">2</span> &amp;&amp; (</div><div class="line">    f.h -= f.w = <span class="number">9</span></div><div class="line">  )</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>后面可以证明我们的猜测并没有错。另外，这段代码最后的&amp;&amp;符号后面的代码，就是灭火的处理函数了。</p><p>遍历数组，我们一般是用<code>forEach</code>，而作者在这个例子中全都是用<code>some</code>来做的。我猜作者并没有别的用意，纯粹是因为长度的原因。所以我觉得这里使用<code>map</code>应该更好。</p><p>接下来是一些零散的处理。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// prepare canvas</span></div><div class="line">c.translate(<span class="number">90</span>, (a.height += <span class="number">0</span>) / <span class="number">2</span> - <span class="number">120</span> | <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">// update entities</span></div><div class="line">entities.some(<span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</div><div class="line">  f.p &amp;&amp; f.p(f)</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>首先是平移了画布，其次是遍历对象数组，执行对象的p函数。这样一来就很清晰了。对象的<strong>属性p，就是在每个事件循环中处理对象的函数</strong>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// draw sky</span></div><div class="line"><span class="keyword">for</span> (i = <span class="number">30</span>; i--;)</div><div class="line">  c.fillStyle = <span class="string">'hsla('</span> + [<span class="number">160</span>, <span class="number">60</span> + <span class="string">'%'</span>, <span class="number">50</span> + i + <span class="string">'%'</span>, <span class="number">1</span>],</div><div class="line">  c.fillRect(<span class="number">0</span>, i * <span class="number">4</span>, <span class="number">320</span>, <span class="number">4</span>);</div></pre></td></tr></table></figure><p>接下来，作者巧妙地用<strong>循环 + hsla</strong>渲染了一个带渐变色的天空。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// remove entities no longer needed</span></div><div class="line">entities = entities.filter(<span class="function"><span class="keyword">function</span> (<span class="params">e, f</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span>(e.h &gt; <span class="number">0</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>这段代码过滤掉了对象数组中h属性不大于0的对象。</p><p>回想一下，我们前面看到的每种对象的p函数，都带着h–，而p函数在每个事件循环都会执行。那么这个h属性表示的就是对象的寿命了。这个事件循环的间隔是33ms，也就是30h相当于1秒。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// draw background forest</span></div><div class="line"><span class="keyword">for</span> (i = <span class="number">30</span>; i--;)</div><div class="line">  c.fillStyle = <span class="string">'hsla('</span> + [<span class="number">160</span>, <span class="number">60</span> + <span class="string">'%'</span>, <span class="number">10</span> + i + <span class="string">'%'</span>, <span class="number">1</span>],</div><div class="line">  c.fillRect(<span class="number">0</span>, <span class="number">220</span> - i * <span class="number">4</span>, <span class="number">320</span>, <span class="number">4</span>);</div><div class="line"></div><div class="line"><span class="comment">// sort entities by distance from the screen</span></div><div class="line">entities.some(<span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</div><div class="line">  f.Z = (f.x - playerX) * <span class="built_in">Math</span>.sin(playerA) + (f.z - playerZ) * <span class="built_in">Math</span>.cos(playerA)</div><div class="line">&#125;);</div><div class="line">entities.sort(<span class="function"><span class="keyword">function</span> (<span class="params">e, f</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span>(f.Z - e.Z)</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// draw ground</span></div><div class="line"><span class="keyword">for</span> (i = <span class="number">30</span>; i--;)</div><div class="line">  c.fillStyle = <span class="string">'hsla('</span> + [<span class="number">10</span> + <span class="number">60</span>, <span class="number">60</span> + <span class="string">'%'</span>, <span class="number">50</span> + i + <span class="string">'%'</span>, <span class="number">1</span>],</div><div class="line">  c.fillRect(<span class="number">0</span>, <span class="number">236</span> - i * <span class="number">4</span>, <span class="number">320</span>, <span class="number">4</span>);</div></pre></td></tr></table></figure><p>接下来的这部分，前面的画背景与后面的画地板还是跟前面一样的套路，分别使用循环来绘制带渐变色的森林与地板。可是中间这段是什么鬼？</p><p>根据注释说明，这个部分是将Z属性设置为对象到屏幕的距离，随后做了一次从近到远排序。</p><p>至于对象到屏幕的距离如何计算，这里直接画图说明，就不再赘述。</p><p><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-calcdist.jpg" alt="计算距离"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// draw entities</span></div><div class="line">entities.some(<span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</div><div class="line">  !f.v &amp;&amp; f.Z &gt; <span class="number">160</span> || f.Z &lt; <span class="number">8</span> ||</div><div class="line">  <span class="built_in">Math</span>.abs(e = (f.x - playerX) * <span class="built_in">Math</span>.cos(playerA) * <span class="number">160</span> / f.Z - (f.z - playerZ) * <span class="built_in">Math</span>.sin(playerA) * <span class="number">160</span> / f.Z) &lt; <span class="number">160</span> &amp;&amp; (</div><div class="line">    c.fillStyle = <span class="string">'hsla('</span> + [f.c[<span class="number">0</span>], f.c[<span class="number">1</span>] + <span class="string">'%'</span>, f.Z / <span class="number">6</span> - f.c[<span class="number">2</span>] + <span class="number">46</span> + <span class="string">'%'</span>, f.S ? <span class="number">1</span> : <span class="number">.8</span>],</div><div class="line">    c.fillRect(</div><div class="line">      <span class="number">160</span> + e - f.s * <span class="number">160</span> / f.Z / <span class="number">2</span>,</div><div class="line">      <span class="number">120</span> - f.y * <span class="number">160</span> / f.Z - (f.S || f.s) * <span class="number">160</span> / f.Z / <span class="number">2</span>,</div><div class="line">      f.s * <span class="number">160</span> / f.Z,</div><div class="line">      (f.S || f.s) * <span class="number">160</span> / f.Z</div><div class="line">    )</div><div class="line">  )</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>接下来的这段代码就是这个游戏的灵魂所在了。</p><p>这是一个遍历entities数组的操作。以 <code>||</code> 符号分割，这个操作可以分为三个部分：</p><ol><li><code>!f.v &amp;&amp; f.Z &gt; 160</code></li><li><code>f.Z &lt; 8</code></li><li><code>Math.abs(...) &lt; 160 &amp;&amp; (...)</code></li></ol><p>语句1跟2只要有一个成立，语句3就不会被执行。语句1跟2也很好理解，主要是判断对象跟屏幕之间的距离是不是处在(8, 160)的区间内，如果不是就直接跳过该对象。</p><p>这里有一个例外情况，在距离大于160的情况下，如果对象带有v属性则还是可以继续后面的判断的。纵观整个代码，带有v属性的只有前面提到的烟雾以及烟花。这就说明烟雾与烟花就算是在160距离开外，依然是可以看到的，事实上也的确如此。</p><p>语句3被 <code>&amp;&amp;</code> 符号分割为了两部分：</p><ol><li><code>Math.abs(e = (f.x - playerX) * Math.cos(playerA) * 160 / f.Z - (f.z - playerZ) * Math.sin(playerA) * 160 / f.Z) &lt; 160</code></li><li><code>(c.fillStyle=&#39;...&#39;,c.fillRect(...))</code></li></ol><p>语句1中的比较，转换为代数式，经过简单的代数变换后，可以变为：</p><p><code>dx*cos(α) - dz*sin(α) &lt; f.Z</code></p><p>结合刚刚的图，这个语句意义就是指，线段a需要小于f.Z。而从图上我们可以知道，线段a就是对象投影在屏幕上后与玩家的距离。这样一来，<strong>视角90°</strong>以外的对象就不会被渲染了。</p><p><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-example.jpg" alt="参考图"></p><p>语句2就是渲染对象的语句了。看到这里的<code>fillStyle</code>函数我们才明白，前面所定义的<code>f.c</code>属性，其实就是定义了对象颜色的hsl值。另外，从<code>fillRect</code>函数的传参情况来看，也很容易看出<code>f.y</code>指的就是对象的y坐标，<code>f.s</code>表示对象的宽高，而<code>f.S</code>则是在绘制树干的时候作为对象的高度来使用。</p><h4 id="再回首" class="post-heading"><a href="#再回首" class="headerlink" title="再回首"></a>再回首<a class="post-anchor" href="#再回首" aria-hidden="true"></a></h4><p>现在我们对这段代码有大概的理解了，是时候回头看一看了。</p><p>首先是创建对象的部分，此处开了两重循环，种下了256课树，每棵树分别有一根树干，12个对象组成的叶子，另外地上有6个果实。</p><p><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-tree.png" alt="树"></p><p>接下来，第30棵树被恶意纵了火（将<code>f.p</code>设置为<code>burn</code>函数），第一棵着火的树还会发出一个烟花作为信号。而由于每一帧最后都有<code>s--</code>语句，这个<code>s</code>被作为一个计数器，让着火的树每16帧发出一个烟圈。</p><p><img src="//misc.aotu.io/Littly/2016-12-04-firewatcher-appreciation-smoke.png" alt="烟雾"></p><p>过后，就是熟悉的与用户交互的环节了。这部分已经十分清晰，就不再赘述。</p><h3 id="写在最后" class="post-heading"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后<a class="post-anchor" href="#写在最后" aria-hidden="true"></a></h3><p>这段代码虽然短，却是麻雀虽小五脏俱全。实现了游戏的基本功能不说，有一些小细节也是让我大吃一惊。比如树着火时冒出的烟，在普通情况下是深灰色的，而在被水枪浇到的时候，会变成浅灰色；又比如寿命的设定，使树叶在着火之后一段时间会被烧完。</p><p>在编程思想上，作者也是很有见地。使用entities数组存储所有对象的信息，给每种对象一个变换函数，这本身就有粒子的思想在其中。此外，<code>setInterval</code>的使用，则是再正常不过的事件循环机制的实现。</p><p>编程手法就不用多说了。比如各种利用<code>some</code>函数代替<code>forEach</code>来省字数，又或者是利用<code>burn[e.keyCode - 32] = e.type[5]</code>来判断按键的状态……作者是老司机，这一点是没跑了。</p><p>这段代码构思巧妙，思路行云流水…类似的溢美之词说再多也没用。更关键的是，我们<strong>干前端这一行的，绝对不只是jQ，选择器，或者node小工具</strong>。偶尔看一看别人的代码，还是能够学到很多意想不到的知识的。</p><h3 id="参考资料" class="post-heading"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料<a class="post-anchor" href="#参考资料" aria-hidden="true"></a></h3><ul><li>js1k官网 <a href="http://js1k.com" target="_blank" rel="external">http://js1k.com</a></li><li>js1k规则页 <a href="http://js1k.com/2016-elemental/rules" target="_blank" rel="external">http://js1k.com/2016-elemental/rules</a></li><li>Romanesco 2.0 <a href="http://js1k.com/2016-elemental/demo/2552" target="_blank" rel="external">http://js1k.com/2016-elemental/demo/2552</a></li><li>Voxeling <a href="http://js1k.com/2016-elemental/demo/2497" target="_blank" rel="external">http://js1k.com/2016-elemental/demo/2497</a></li><li>Firewatch <a href="http://js1k.com/2016-elemental/demo/2512" target="_blank" rel="external">http://js1k.com/2016-elemental/demo/2512</a></li><li>Firewatch 源码 <a href="http://js1k.com/2016-elemental/details/2512" target="_blank" rel="external">http://js1k.com/2016-elemental/details/2512</a></li></ul><div class="post-tags" style="display:none"><a href="/tags/js1k-游戏-3D/">js1k 游戏 3D</a></div><div class="post-categories" style="display:none"></div><div class="post-revision"><i class="fa fa-clock-o"></i> <time class="post-updated" datetime="2016-12-22T09:53:25.577Z">上次更新：2016-12-22 17:53:25</time></div></div><div class="post-nav"><div class="post-nav-next"><a href="/notes/2016/12/07/regexp-practice/" title="正则表达式实践篇">正则表达式实践篇 <i class="fa fa-chevron-right"></i></a></div><div class="post-nav-prev"><a href="/notes/2016/12/02/jcloud/" title="项目心得 -- 京东云改版"><i class="fa fa-chevron-left"></i> 项目心得 -- 京东云改版</a></div></div><div class="post-comments" id="comments"><div class="ds-thread" data-thread-key="bm90ZXMvMjAxNi8xMi8wNC9maXJld2F0Y2hlci1hcHByZWNpYXRpb24v" data-title="源码赏析 - 1K的Firewatch游戏" data-url="https://demo.lilidong.cn/notes/2016/12/04/firewatcher-appreciation/index.html"></div><script type="text/javascript">var duoshuoQuery={short_name:"Jackieli"};!function(){var t=document.createElement("script");t.id="duoshuo-script",t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script></div></article></div><aside class="mod-side" id="sidebar"><div class="mod-side-sec aotuwx"><img class="aotuwx-qrcode" src="/img/qrcode.jpg" alt="关注我们"><div class="aotuwx-slogan">每周五推送精选技术文章</div></div><div class="mod-side-sec works"><div class="mod-side-sec-hd"><h2>服务/产品</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="//cases.aotu.io/mobi/maga.html" target="_blank" title="拇指期刊">拇指期刊</a></li><li><a href="//athena.aotu.io/" target="_blank" title="Athena">Athena</a></li><li><a href="//guide.aotu.io/" target="_blank" title="前端代码规范">前端代码规范</a></li><li><a href="//halojs.aotu.io/" target="_blank" title="HaloJS">HaloJS</a></li><li><a href="//sign.aotu.io/" target="_blank" title="邮件签名工具">邮件签名工具</a></li><li><a href="//mac.aotu.io/" target="_blank" title="MAC全栈环境">MAC全栈环境</a></li></ul></div></div><div class="mod-side-sec favlinks"><div class="mod-side-sec-hd"><h2>友情链接</h2></div><div class="mod-side-sec-bd"><ul class="mod-side-list"><li><a href="https://jdc.jd.com" target="_blank" title="京东设计中心">JDC京东设计中心</a></li><li><a href="http://fex.baidu.com" target="_blank" title="百度Web前端研发部">百度FEX</a></li><li><a href="http://taobaofed.org" target="_blank" title="淘宝前端团队">淘宝FED</a></li><li><a href="http://tgideas.qq.com" target="_blank" title="腾讯互娱设计中心">TGIdeas</a></li><li><a href="http://isux.tencent.com" target="_blank" title="腾讯SNG设计中心">ISUX</a></li><li><a href="http://cdc.tencent.com" target="_blank" title="腾讯用户研究与体验设计中心">CDC</a></li><li><a href="http://ued.ctrip.com" target="_blank" title="携程设计委员会">携程UED</a></li></ul></div></div></aside></div></div><div class="mod-backtop" id="backTop"><i class="fa fa-long-arrow-up"></i></div><footer class="mod-ft" id="footer"><div class="grid"><ul class="mod-ft-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="https://github.com/jackieli-json/jackieli-json.github.io" target="_blank"><i class="fa fa-github-alt"></i></a></li></ul><div class="mod-ft-sec mod-ft-copyright"><p>Designed by <a href="http://lilidong.cn" target="_blank">西门互联</a></p><p>Copyright &copy; 2016. All Rights Reserved.</p></div></div></footer><script src="/js/bundle/core.js"></script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e850b980d029480b092fdd7503c3f8de";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><style>#cnzz_stat_icon_1258539944{display:none}</style><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?" https://":" http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1258539944'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s11.cnzz.com/z_stat.php%3Fid%3D1258539944' type='text/javascript'%3E%3C/script%3E"))</script></body></html>